% Fonts + Colors ~~~~

\usepackage{lipsum}
\usepackage{fontspec}
\usepackage{dashrule}
\usepackage[export]{adjustbox}
\usepackage[usenames, dvipsnames]{color}
\usepackage{comment}

\definecolor{Gray}{RGB}{120, 120, 120}
\definecolor{LogoRed}{RGB}{153, 0, 0}
\definecolor{LogoTurquoise1}{RGB}{1, 123, 147}
\definecolor{LogoTurquoise2}{RGB}{0, 158, 171}
\definecolor{LogoTurquoise3}{RGB}{0, 186, 187}
\definecolor{BackgroundBlue}{RGB}{247, 254, 255}
\definecolor{LightBlue}{RGB}{230, 247, 255}
\definecolor{LightRed}{RGB}{231, 103, 97}
\definecolor{DarkGray}{RGB}{71, 71, 71}
\definecolor{JoyceBlue}{RGB}{51, 110, 184}

\begin{comment}
\newfontfamily\Avenir[
    Path= fonts/,
    Extension= .otf,
    UprightFont = *-45Book,
    ItalicFont = *-45BookOblique,
    BoldFont = *-95Black,
]{AvenirLTStd}

\newfontfamily\TradeGothic[
    Path = fonts/,
    Extension = .otf,
    UprightFont = *-No18,
    BoldFont = *-No20Bold,
]{TradeGothicCondensed}

\setmainfont[Ligatures=TeX]{Avenir}
\Avenir\fontsize{9pt}{12pt}\selectfont

\end{comment}

\usepackage[condensed]{roboto}
\usepackage[default,osfigures,scale=0.95]{opensans}
\usepackage[T1]{fontenc}

\fontsize{9pt}{12pt}\selectfont

% Formatting ~~~~

\usepackage{geometry}

\geometry{
    letterpaper,
    top=1.75in,
    bottom=1.75in,
    inner=0.75in,
    outer=0.75in,
    headsep=1in,
    headheight=0.5in,
    footskip=1in,
    % showframe
}

\usepackage[document]{ragged2e}
\parskip=8pt
\parindent=0pt
\linespread{1.2}
\setlength{\columnsep}{0.75cm}

% \usepackage{sectsty}
% \sectionfont{\fontfamily{pag}\selectfont\color{LogoTurquoise1}\vspace{-\parskip}\Large\uppercase}
% \subsectionfont{\color{LogoTurquoise1}\vspace{-\parskip}\mdseries\Large}

\usepackage{titlesec}
\titleformat*{\section}{\fontfamily{pag}\selectfont\color{LogoTurquoise1}\vspace{-\parskip}\bfseries\Large\uppercase}
\titleformat*{\subsection}{\color{LogoTurquoise1}\vspace{-\parskip}\Large}

\usepackage{etoolbox}
\AfterEndEnvironment{table-env}{\restoregeometry\twocolumn}
\AfterEndEnvironment{lscape-env}{\restoregeometry\twocolumn}

% Headers + Footers ~~~~

\usepackage{pdflscape}
\usepackage[table]{xcolor}
\usepackage{tikz}

\usepackage{fancyhdr}
\pagestyle{fancy}

\renewcommand{\sectionmark}[1]{\markboth{#1}{}}

\fancyhead{} % clear all header fields
\fancyfoot{} % clear all footer fields
\fancyhead[R]{\href{https://emraresearch.org}{emraresearch.org}}
\fancyfoot[LE]{\thepage \hspace{0.4cm} \roboto\selectfont\textcolor{LightRed}{\uppercase{Recruiting the Out-of-State University}}}
\fancyfoot[RO]{\roboto\selectfont\textcolor{Gray}{\leftmark} \hspace{0.4cm} \thepage}
\renewcommand{\headrulewidth}{0pt}

\fancypagestyle{intro-style}{
    \fancyhead{}
    \fancyfoot{}
    \fancyhead[R]{\href{https://emraresearch.org}{emraresearch.org}}
}

\fancypagestyle{lscape-style}{  % landscape header/footer
    \fancyhead{}
    \fancyfoot{}
    \fancyhead[R]{%
    \tikz[remember picture,overlay]
      \node[outer sep=1cm,above,xshift=1in,yshift=0.15in,rotate=90] at (current page.135) {\href{https://emraresearch.org}{emraresearch.org}};}
    \fancyfoot[LE]{%
    \tikz[remember picture,overlay]
      \node[outer sep=1cm,above,yshift=0.85in,rotate=90] at (current page.315) {\thepage \hspace{0.4cm} \roboto\selectfont\textcolor{LightRed}{\uppercase{Recruiting the Out-of-State University}}};}
    \fancyfoot[RO]{%
    \tikz[remember picture,overlay]
      \node[outer sep=1cm,above,yshift=0.25in,rotate=90] at (current page.45) {\roboto\selectfont\textcolor{Gray}{\leftmark} \hspace{0.4cm} \thepage};}
}


% Links + Lists ~~~~

\PassOptionsToPackage{hyphens}{url}\usepackage[colorlinks=true, linkcolor=cyan, urlcolor=blue, citecolor=blue, breaklinks=true]{hyperref}
\newcommand{\superscript}[1]{$^{#1}$}

%reference list stuff
\usepackage[natbibapa]{apacite}

%\usepackage[super,numbers]{natbib}

\makeatletter
\renewcommand\@biblabel[1]{\superscript{#1}}
\makeatother

\renewcommand{\refname}{\vspace{-0.65cm}}

\usepackage{enumitem}
\setlist{nosep, itemsep=0pt, parsep=0pt}

\renewcommand{\labelitemi}{\color{LightRed}$\triangleright$}
\renewcommand{\labelitemii}{\color{LogoTurquoise2}$\cdot$}
\renewcommand\labelitemiii{$\circ$}


% Block Formats ~~~~

\usepackage{mdframed}

\newenvironment{quote-block}{  % quote block
    \begin{quote}
    \roboto\selectfont
    \color{LogoTurquoise2}
}
{
    \end{quote}
}

\newenvironment{color-block}[1][Key Points]{  % text block
    \vspace{0.5cm}
    \begin{mdframed}[backgroundcolor=LightBlue, linecolor=LightBlue, userdefinedwidth=\textwidth, leftmargin=0cm, innerleftmargin=1cm, innerrightmargin=2cm, innertopmargin=0.5cm, innerbottommargin=1cm]
    \color{DarkGray}
    \subsection*{\color{LogoTurquoise1}{\Large#1}}
    \vspace{-0.2cm}
}
{
    \end{mdframed}
    \vspace{-0.3cm}
}


% Figures ~~~~

\usepackage{graphicx}
\usepackage{afterpage}

\usepackage{caption}
\usepackage[labelformat=simple]{subcaption}

\DeclareCaptionSubType*{figure}
\renewcommand\thesubfigure{}

\DeclareCaptionFont{CaptionFont}{\roboto\selectfont}
\DeclareCaptionFont{LightRed}{\color{LightRed}}

\captionsetup{labelfont={CaptionFont, LightRed}, figurename=FIGURE, tablename=TABLE}

% Params: border color (default: White), filename in the images/ folder, caption, fig reference (e.g., ~\ref{fig:funnel}), left, bottom, right, top crop
\newcommand{\addFigure}[9][White] {  % Add single figure
\begin{figure}[!h#9]
    \vspace{0.2cm}
    \centering

    \includegraphics[width=0.45\textwidth, cfbox=#1 0.4pt, trim={#5cm #6cm #7cm #8cm}, clip]{images/#2}
    \caption{\roboto\selectfont\textcolor{Gray}{\uppercase{#3}}}
    \label{fig:#4}

\end{figure}
}

% Params: placement (default: b), filename in the images/ folder, caption, fig reference (e.g., ~\ref{fig:funnel}), border color
\newcommand{\addFullFigure}[5][b] {  % Add single figure that spans 2 cols
\afterpage{
\begin{figure*}[!h#1]
    \vspace{0.2cm}
    \centering

    \includegraphics[width=0.8\textwidth, cfbox=#5 0.4pt]{images/maps/#2}
    \caption{\roboto\selectfont\textcolor{Gray}{\uppercase{#3}}}
    \label{fig:#4}
    
    \ifnum\pdfstrcmp{#1}{b}=0
      \vspace{-1cm}
    \fi

\end{figure*}
}
}

% Params: (legend), image filename/fig reference, legend position, crop, subcaptions, width
\usepackage{stfloats}
\newcommand{\addFigureSet}[9][x] {  % Add 2x2 figure set
\afterpage{
\ifnum\pdfstrcmp{#1}{x}=0
  \begin{figure*}[b]
\else
  \begin{figure*}[t]
\fi

    \ifnum\pdfstrcmp{#1}{x}=0
      \vspace{0.45cm}
    \fi

    \centering

    \ifnum\pdfstrcmp{#1}{x}=-1
      \hspace*{0.4cm}
    \fi
    \begin{subfigure}[b]{#9\linewidth}
      \includegraphics[width=\linewidth, cfbox=Gray 0.4pt]{images/maps/#2_1}
      \caption{#5}
    \end{subfigure}\hfill
    \begin{subfigure}[b]{#9\linewidth}
      \includegraphics[width=\linewidth, cfbox=Gray 0.4pt]{images/maps/#2_2}
      \caption{#6}
    \end{subfigure}
    \ifnum\pdfstrcmp{#1}{x}=-1
      \hspace*{0.4cm}
    \fi

    \smallskip

    \ifnum\pdfstrcmp{#1}{x}=-1
      \hspace*{0.4cm}
    \fi
    \begin{subfigure}[b]{#9\linewidth}
      \includegraphics[width=\linewidth, cfbox=Gray 0.4pt]{images/maps/#2_3}
      \caption{#7}
    \end{subfigure}\hfill
    \begin{subfigure}[b]{#9\linewidth}
      \includegraphics[width=\linewidth, cfbox=Gray 0.4pt]{images/maps/#2_4}
      \caption{#8}
    \end{subfigure}
    \ifnum\pdfstrcmp{#1}{x}=-1
      \hspace*{0.4cm}
    \fi

    \ifnum\pdfstrcmp{#1}{x}=-1
      \begin{tikzpicture}[remember picture,overlay]
           \node [outer sep=1cm,above,yshift=#4in] at (0,0)  % 1.25
             {\includegraphics[width=0.25\linewidth, cfbox=Gray 0.4pt]{images/maps/#1}};
      \end{tikzpicture}
    \fi

    \caption{\roboto\selectfont\textcolor{Gray}{\uppercase{#3}}}
    \label{fig:#2}

    \ifnum\pdfstrcmp{#1}{x}=0
      \vspace{-1cm}
    \else
      \vspace{0.45cm}
    \fi

\end{figure*}
}
}

% Params: top or bottom of page (default: b), filename in the images/ folder, caption, fig reference x2
\newcommand{\addTwoFigures}[7][b] {  % Add side-by-side figures

\begin{figure*}[#1]

    \begin{minipage}[c]{0.47\textwidth}
        \includegraphics[width=\linewidth, cfbox=Gray 0.4pt, trim={1.6in 1.5in 1.5in 2in}, clip]{images/#2}
        \caption{\roboto\selectfont\textcolor{Gray}{\uppercase{#3}}}
        \label{fig:#4}
    \end{minipage}
    \hfill
    \begin{minipage}[c]{0.47\textwidth}
        \includegraphics[width=\linewidth, cfbox=Gray 0.4pt, trim={1.6in 1.5in 1.5in 2in}, clip]{images/#5}
        \caption{\roboto\selectfont\textcolor{Gray}{\uppercase{#6}}}
        \label{fig:#7}
    \end{minipage}

    \ifnum\pdfstrcmp{#1}{b}=0
        \vspace{-1cm}
    \fi

\end{figure*}

}

\usepackage{setspace}
% Params: filename in the graphs/ folder, caption, fig reference, footnotes
\newcommand{\addSmallMultiples}[5][1.2] {  % Add 3x5 figure set
\afterpage{
\ifnum\pdfstrcmp{#1}{1.5}=0
  \newgeometry{
    top=0.25in,
    bottom=1.25in,
    inner=0.75in,
    outer=0.75in,
    headsep=0in,
    footskip=0.5in,
    includehead
  }
\else
  \newgeometry{
    top=0.75in,
    bottom=1.25in,
    inner=0.75in,
    outer=0.75in,
    headsep=0in,
    headheight=0.5in,
    footskip=0.5in
  }
\fi

\begin{figure*}[t]
    \vspace{0.45cm}
    \centering
    
    \caption{\roboto\selectfont\textcolor{Gray}{\uppercase{#3}}}
    \label{fig:#4}

    \includegraphics[width=0.3\textwidth, page=9, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}\hfill
    \includegraphics[width=0.3\textwidth, page=2, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}\hfill
    \includegraphics[width=0.3\textwidth, page=1, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}

    \smallskip

    \includegraphics[width=0.3\textwidth, page=8, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}\hfill
    \includegraphics[width=0.3\textwidth, page=14, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}\hfill
    \includegraphics[width=0.3\textwidth, page=10, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}

    \smallskip

    \includegraphics[width=0.3\textwidth, page=11, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}\hfill
    \includegraphics[width=0.3\textwidth, page=4, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}\hfill
    \includegraphics[width=0.3\textwidth, page=12, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}

    \smallskip

    \includegraphics[width=0.3\textwidth, page=6, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}\hfill
    \includegraphics[width=0.3\textwidth, page=13, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}\hfill
    \includegraphics[width=0.3\textwidth, page=16, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}

    \smallskip

    \includegraphics[width=0.3\textwidth, page=5, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}\hfill
    \includegraphics[width=0.3\textwidth, page=3, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}\hfill
    \includegraphics[width=0.3\textwidth, page=7, cfbox=Gray 0.4pt, trim={#1in 1.5in 1.5in 1.5in}, clip]{graphs/#2}

    \ifnum\pdfstrcmp{#1}{1.5}=0
      \begin{flushleft}
        \begin{footnotesize}
          \begingroup\onehalfspacing
            \color{DarkGray}
            #5
          \endgroup
        \end{footnotesize}
      \end{flushleft}
    \fi

\end{figure*}

\restoregeometry
\twocolumn
\clearpage
}
}


% Tables ~~~~

\usepackage[figuresright]{rotating}
\usepackage{multirow}

% Params: top or bottom of page (default: b), filename in the tables/ folder, caption, tbl reference
\newcommand{\addTable}[4][b] {  % Add Table

\begin{table*}[!h#1]

    \centering
    
    \ifnum\pdfstrcmp{#2}{data_appendix}=0
      \caption{\roboto\selectfont\textcolor{Gray}{\uppercase{#3}}}
      \label{tbl:#4}
    \fi

    \begingroup
      \fontsize{8pt}{10pt}\selectfont
      \input{tables/#2.tex}
    \endgroup

    \ifnum\pdfstrcmp{#2}{data_appendix}=1
      \vspace{0.2cm}
      \caption{\roboto\selectfont\textcolor{Gray}{\uppercase{#3}}}
      \label{tbl:#4}
    \fi

    \ifnum\pdfstrcmp{#1}{b}=0
      \vspace{-1cm}
    \fi

\end{table*}

}

% Params: line spacing (default: 10pt), filename in the tables/ folder, caption, tbl reference (or `x` if continued table), footnotes
\newcommand{\addLandscapeTable}[5][10] {  % Add Landscape Table
\afterpage{
\pagestyle{lscape-style}
\newgeometry{top=0.5in, bottom=0.5in, inner=0in, outer=0in}

\begin{table*}[!ht]

\centering

\rotatebox{90}{
\begin{minipage}{\textheight}

    \vspace{-0.5cm}

    \ifnum\pdfstrcmp{#4}{x}=0
      \ContinuedFloat
    \fi
    \caption{\roboto\selectfont\textcolor{Gray}{\uppercase{#3}}}
    \label{tbl:#4}

    \begingroup
      \fontsize{8pt}{#1pt}\selectfont
      \input{tables/#2.tex}
    \endgroup
    
    \begin{flushleft}
      \begin{footnotesize}
        \begingroup\onehalfspacing
          \color{DarkGray}
          #5
        \endgroup
      \end{footnotesize}
    \end{flushleft}

\end{minipage}}
\end{table*}

\restoregeometry
\twocolumn
\clearpage
}
}

% Appendix ~~~~

\usepackage{xparse}
\usepackage{xpatch}

% Do not a driver counter, i.e. a resetting counter for those two counter fellows here:
\newcounter{lofcntr}
\newcounter{lotcntr}

\NewDocumentCommand{\clearcontents}{}{%
  \stepcounter{lofcntr}% We don't need labels here, I suppose?
  \stepcounter{lotcntr}%
  \setcounter{figure}{0}
  \setcounter{table}{0}
}

\makeatletter
\renewcommand\listoffigures{%
  \@starttoc{lof}%
}
\makeatother

\makeatletter
\renewcommand\listoftables{%
  \@starttoc{lot}%
}
\makeatother

\AtBeginDocument{%
  \stepcounter{lofcntr}%
  \stepcounter{lotcntr}%
}

\makeatletter
% Store the definition of \ext@figure etc. first
\let\latex@ext@figure\ext@figure
\let\latex@ext@table\ext@table

\AtBeginDocument{%
\xpretocmd{\caption}{%
  % Prepend the extension with the number of the current list of ...
  \def\ext@figure{\number\value{lofcntr}\latex@ext@figure}
  \def\ext@table{\number\value{lotcntr}\latex@ext@table}
}{\typeout{Worked!}}{\typeout{Failed miserably!}}
}

\xpatchcmd{\listoffigures}{%
  \@starttoc{lof}%
}{%
  \@starttoc{\number\value{lofcntr}lof}%
}{\typeout{Patch success}}{\typeout{Patch failure}}

\xpatchcmd{\listoftables}{%
  \@starttoc{lot}%
}{%
  \@starttoc{\number\value{lotcntr}lot}%
}{\typeout{Patch success}}{\typeout{Patch failure}}

\makeatother
